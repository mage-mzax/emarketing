/*TODO*/ 

window.mzax=window.mzax||{},function(a,b){function c(a,b,c){var d=setInterval(function(){"complete"===a.readyState&&(clearInterval(d),b.call(c||a))},10);return d}function d(a){return!!(a||"").toLowerCase().match(/(1|yes|true|y|enabled?)/)}function e(a,b,c){return Math.min(Math.max(a,b),c)}function f(a){a=(a||"").replace(/^(\s+)/gm,function(a){return a.replace(/\t/g,"    ")}),a=a.replace(/^(\s*)\r?\n(\s+)/,"$2");var b=a.match(/^ +/);return b?a.replace(new RegExp("^ {0,"+b[0].length+"}","gm"),""):a}function g(a){return(a+"").toLowerCase().replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function(a){return a.toUpperCase()})}function h(a){return g(a.replace(/(.)([A-Z])/g,"$1 $2").replace(/[\W_-]+/g," "))}function i(a){return a.outerHTML||function(a){var b=o.createElement("div");return b.appendChild(a.cloneNode(!0)),b.innerHTML}(a)}function j(a){var b=o.createElement("textarea");return b.innerHTML=a,b.value}function k(a){for(var b=p.length;--b>-1;)p[b].call(a,a)}function l(a,b,c){for(var d in a)if(a.hasOwnProperty(d)&&b.call(c||a,a[d],d)===!1)return d;

return!0}function m(a,b,c){c=c||a;for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d]))return a[d];return void 0}function n(a){for(var b=[],c=a.querySelectorAll("[mage\\:editable]"),d=0,e=c.length;e>d;d++)switch((c[d].getAttribute("mage:editable")||"0").toLowerCase()){case"yes":case"1":case"y":b.push(c[d])}return b}b.ui=b.ui||{};var o=a.document,p=[],q=1e3;ace.require("ace/ext/mage_autocomplete"),b.jQueryPlugin=function(a){return p.push(a),a},b.ui.Placeholder=Class.create({REGEX_PLACEHOLDER:/\{\{([^\[\}])+\}\}/g,REGEX_VALIDATE:/^\{\{(\/)?([a-z0-9]+)\s*(?:\s([^\}]+?))?\}\}$/i,REGEX_PARAMS:/(?:(?:([a-z_-]+)=)?(?:([^\s]+\([^)]*([^)]+\)))|([^\s"']+)|"([^"]*)"|'([^']*)'))/g,REGEX_PARAM:/^(?:(?:([a-z_-]+)=)?(?:([^\s"']+)|"([^"]*)"|'([^']*)'))$/,initialize:function(a){a&&this.parse(a)},encode:function(){return this.expr?encodeURI("encode:"+this.render()):null},parse:function(a){0===a.indexOf("encode:")&&(a=decodeURI(a.substr(7)));var b=a.match(this.REGEX_VALIDATE);if(b){switch(this.expr=a,this.valid=!0,
this.closing=!!b[1],this.directive=b[2].toLowerCase(),this.input=null,this.params={},this.isBlock=!1,this.isLang=!1,this.directive){case"depend":case"if":case"else":this.input=b[3]||"",this.isLang=!0;break;case"block":case"layout":case"include":case"widget":this.isBlock=!0;case"htmlescape":case"store":case"skin":case"coupon":case"media":case"customvar":case"config":this.params=this.parseParams(b[3]);break;default:this.input=b[3]}return!0}return this.valid=!1,!1},parseParams:function(a){var b,c,d={},e=a.match(this.REGEX_PARAMS);if(e)for(c=0;c<e.length;c++)b=e[c].match(this.REGEX_PARAM),b[1]?d[b[1]]=b[2]||b[3]||b[4]||b[5]:d[b[2]||b[3]||b[4]||b[5]]=!0;return d},render:function(){if(this.closing)return this.expr="{{/"+this.directive+"}}";var a=[this.directive];if(this.input)a.push(this.input);else for(var b in this.params)this.params.hasOwnProperty(b)&&a.push(b+"="+JSON.stringify(this.params[b]));return this.expr="{{"+a.join(" ")+"}}"},getPreview:function(a){if(!a)return"N/A";var b;return h((b=a.match(/([a-z._-]+)\.get([a-z0-9]+)\(/i))?b[1]+" "+b[2]:(b=a.match(/([a-z._-]+)\.[a-z0-9]+\(/i))?b[1]:a);

},toElement:function(a){function b(a,b){return'<span class="mzax-center"><span class="mzax-title">'+(a||"")+'</span><span class="mzax-info">'+(b||"")+"</span></span>"}a&&this.render();var c=new Element("span",{"class":"mzax-placeholder"}),d=this.params,e=this.directive;switch(c.addClassName(this.isBlock?"is-block":"is-inline"),c.addClassName(e),e){case"include":c.update(b("Include Template",d.template));break;case"layout":c.update(b("Layout Handle",d.handle));break;case"widget":c.update(b("Widget",d.type));break;case"block":c.update(b(d.type||"Block",d.id||d.template));break;case"store":case"skin":case"media":c.update("("+e+": "+(d.url||"")+")");break;case"var":c.update(this.getPreview(this.input));break;case"config":c.update(d.path);break;case"customvar":c.update(this.getPreview(d.code));break;case"coupon":c.update("COUPON[#"+d.rule+"]");break;case"htmlescape":c.update(this.getPreview(d["var"]));break;case"if":case"depend":c.addClassName("is-lang"),c.update(this.closing?"/"+e.toUpperCase():e.toUpperCase()+" ( "+this.getPreview(this.input)+" )");

break;case"else":c.addClassName("is-lang"),c.update("ELSE");break;default:c.update(this.expr)}return c},toText:function(){var a=this.params,b=this.directive;switch(b){case"include":case"layout":case"widget":case"block":return this.expr;case"store":case"skin":case"media":return a.url;case"var":return this.getPreview(this.input);case"config":return a.path;case"customvar":return this.getPreview(a.code);case"htmlescape":return this.getPreview(a["var"]);case"if":case"depend":case"else":return"";default:return this.expr}},toHtml:function(a){var b=this.toElement(a);return i(b)}}),function(a){a.replaceHtml=function(b,c,d){var e,f="@@@!{!{!----!%s!----!}!}!@@@",g=b.ownerDocument,h={},i=Math.ceil(1e6*Math.random()),j=d&&n(b);if(walker=g.createTreeWalker(b,NodeFilter.SHOW_TEXT,function(a){return a.nodeValue.length<=5?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},!1),j)for(var k=0,l=j.length;l>k;k++){var m=j[k],o=f.replace("%s",++i);h[o]=m.innerHTML,m.innerHTML=o}for(;e=walker.nextNode();)e.nodeValue=e.nodeValue.replace(a.prototype.REGEX_PLACEHOLDER,function(b){
var d=new a(b);if(d.valid){var g=f.replace("%s",++i);return h[g]=c?c.call(e,d,!0):d.toHtml(),g}});var p=a.replace(b.innerHTML,function(a){var b=f.replace("%s",++i);return h[b]=c?c.call(e,a,!1):a.toText(),b});b.innerHTML=p.replace(new RegExp(f.replace("%s","[0-9]+"),"g"),function(a){return h[a]?h[a]:a})},a.replace=function(b,c){return b.replace(a.prototype.REGEX_PLACEHOLDER,function(b){var d=new a(b);if(d.valid)return c?c.call(d,d,b):d.toText()})}}(b.ui.Placeholder),b.ui.EditorField=Class.create({initialize:function(a,b){this.id=a||"",this.value=null,this.remove=!1,this.removable=!1,this.element=null,this.index=b||0,this.type="html",this._refresh=[],this.children={},this.uid=q++},sleep:function(){return{remove:this.remove,alt:this.alt||null,value:this.getValue()}},load:function(a){return this.remove=!!a.remove,this.alt=a.alt||null,this.value=a.value||null,this},setElement:function(a){return this.element||(this.element=a,this._clone=a.clone(),a.data("field",this),this.parent=a.parents("[mage\\:id]").data("field"),
this.parent&&(this.parent.children[this.id]=this)),this},_walk:function(a){var b,c=this.children;for(b in c)c.hasOwnProperty(b)&&a.call(this,c[b],b)},swap:function(a){var b=this.index;return this.index=a.index,a.index=b,this._walk(function(b,c){b.swap(a.children[c])}),this},flagAsDeleted:function(){var a;this.deleted=!0,this.parent=null,this.element&&(this.cke&&this.cke.destroy(!1),this.element.remove());for(a in this)this.hasOwnProperty(a)&&this[a]&&"object"==typeof this[a]&&this[a].remove&&this[a].jquery&&this[a].remove();this._walk(function(a){a.flagAsDeleted()})},clone:function(){return this._clone.clone()},setValue:function(a){return this.cke?(this.value=f(a),this.cke.setData(a)):"html"===this.type&&this.element?(this.value=f(a),this.element.html(a),b.ui.Placeholder.replaceHtml(this.element.get(0)),this.onHtmlChange&&this.onHtmlChange(this.element)):"css"===this.type&&this.element?(this.value=f(a),this.element.html(a),this.onHtmlChange&&this.onHtmlChange(this.element)):this.value=a,
this},getValue:function(){return this.cke?this.cke.getData():this.value},refreshUi:function(a){var b=this._refresh,c=b.length;if("function"==typeof a)b.push(a);else for(;--c>-1;)b[c].call(this,a);return this}}),b.ui.EditorField.indexSort=function(a,b){return a.index-b.index},b.ui.PreviewFrame=Class.create({version:1,initialize:function(a,b){var c=this;c.mediaUrl="/media/",c.skinUrl="/skin/",c.storeUrl="/skin/",c.$=a,c.ckeditorSrc="/js/mzax/ckeditor/ckeditor.js",c.jquerySrc="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.js",c.editorCss="/skin/adminhtml/default/default/mzax/editor.css",c.imageFlag=!0,c.enableCKEditor=!0,c.enableAce=!0,Object.extend(this,b||{}),c.init(),b.html&&c.setHtml(b.html),b.startEdit&&c.editMode()},init:function(){var a=this,b=a.$;b.innerHTML='<div class="mzax-editor-header"></div><iframe class="mzax-editor-frame"></iframe><div class="mzax-editor-footer"></div><div class="mzax-editor-input"><div class="controls"></div><div class="input-wrapper"><textarea class="text-input"></textarea></div></div><div class="mzax-loader"><div class="label"></div></div>',
b.addClassName("mzax-editor"),a.iframe=b.down(".mzax-editor-frame"),a.input=b.down(".mzax-editor-input"),a.loader=b.down(".mzax-loader"),a.loader.down(".label").innerHTML="Loading Editor",Element.hide(a.input),Element.hide(a.loader),a.enableAce&&ace&&(a.ace=ace.edit(b.down(".text-input")),a.ace.setMageSnippets(a.snippets),a.ace.owner=a,a.ace.setTheme("ace/theme/mage"),a.ace.getSession().setMode("ace/mode/mage"),a.ace.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableMageLiveAutocompletion:!0}),a.ace.browserMedia=function(){a.browserMedia(function(b){a.ace.insert(b)},!1)},a.ace.insertWidget=function(){a.insertWidget(function(b){a.ace.insert(b)},!1)});var c=b.down(".controls");a._createButton({label:"Apply",cls:"save btn-right",target:c,click:a.applyChanges.bind(a)}),a._createButton({label:"Discard",cls:"back btn-right",target:c,click:a.discardChanges.bind(a)}),a.ace&&(a._createButton({label:"Insert Variable",cls:"mzax-code html-only",target:c,click:function(){a.ace.execCommand("mage",{
source:"mage"})}}),a._createButton({label:"Insert Image",cls:"mzax-image html-only",target:c,click:function(){a.browserMedia(function(b){a.ace.insert(b)},!1)}}),a._createButton({label:"Insert Widget",cls:"mzax-widget html-only",target:c,click:function(){a.insertWidget(function(b){a.ace.insert(b)},!1)}}))},_createButton:function(a){var b=new Element("button",{type:"button","class":"scalable "+(a.cls||"")}).update("<span>"+a.label+"</span>");return a.click&&b.observe("click",a.click),a.target&&a.target.insert(b),b},setHtml:function(b,d){if(this._lastScrollTop=this.scrollTop(),this.documentLoaded=!1,this.editorReady=!1,this.html=b,this.preview=d||!1,this.jQuery=null,this.CKEDITOR=null,this._customStyles=null,this.iframe)try{this.iframe.src=""}catch(e){}return this.cancelEditorLoad&&this.cancelEditorLoad(),this._docTimer&&clearInterval(this._docTimer),Element.show(this.loader),this._docTimer=c(a.document,function(){var a=this.getDocument();a.open(),a.write(b),a.close(),this.initDocument()}.bind(this)),
this},scrollTop:function(a){return this.html&&this.documentLoaded?("undefined"!=typeof a&&this.getFrameWindow().scrollTo(0,a),this.getFrameWindow().scrollY):0},setValue:function(a){if(a)try{this.setData(JSON.parse(a))}catch(b){return!1}else this.setData(null);return!0},setData:function(a){if(!a)return this.fields=null,this.customCss=null,this.html&&this.setHtml(this.html),this;this._data=a,this.fields=null;var c,d;if(a&&a.fields)for(c in a.fields)if(a.fields.hasOwnProperty(c))for(d=0;d<a.fields[c].length;d++)this.getField(c,d).load(a.fields[c][d]||{});return a.customCss&&(this.customCss=new b.ui.EditorField,this.customCss.load(a.customCss),this.customCss.type="css"),this.html&&this.setHtml(this.html),this},getData:function(){this.refreshUi();var a,b,c,d,e={version:this.version},f={},g=this.fields;if(g)for(c in g)if(g.hasOwnProperty(c))for(d=f[c]=[],b=0;b<g[c].length;b++)(a=g[c][b])&&d.push(a.sleep());return this.customCss&&(e.customCss=this.customCss.sleep()),e.fields=f,e},getValue:function(){
return JSON.stringify(this.getData())},renderPlaceholders:function(a){var c=this;b.ui.Placeholder.replaceHtml(c.getDocument().body,function(a,b){switch(a.directive){case"media":case"skin":return c.getImagePreviewUrl(a.expr)}if(c.snippets){var d=m(c.snippets,function(b){return h(b.snippet)===h(a.expr)?b:void 0});if(d){if(b&&d.html)return d.html;if(d.text)return d.text}}return b?a.toHtml():a.toText()},a||!1)},initDocument:function(){var a=this;a.documentLoaded=!0,a.preview&&(a.renderPlaceholders(),a.editorCss&&a.loadStyle(a.editorCss)),a.scrollTop(a._lastScrollTop||0),a.editModeFlag?a.loadEditor():Element.hide(a.loader),a._disableLinks&&a.disableLinks(a._disableLinks)},getDocument:function(){var a=this.iframe;return this.content=a.contentWindow?a.contentWindow.document:a.contentDocument&&a.contentDocument.document?a.contentDocument.document:a.contentDocument,this.content},getFrameWindow:function(){var a=this.getDocument();return a.parentWindow||a.defaultView},select:function(a){var b=this.getDocument();

return b?Element.select(b,a):[]},get:function(a){var b=this.select(a);return b.length?b[0]:null},loadScript:function(a){if(!this.documentLoaded)throw new Error("Document is not yet loaded and ready");var b=this.getDocument();c(b,function(){var b=new Element("script",{type:"text/javascript",src:a}),c=this.select("head");1===c.length?c[0].appendChild(b):alert("todo, no head tag found")},this)},loadStyle:function(a){if(!this.documentLoaded)throw new Error("Document is not yet loaded and ready");var b=this.getDocument();c(b,function(){var b=new Element("link",{href:a,rel:"stylesheet",type:"text/css",media:"all"}),c=this.select("head");1===c.length?c[0].appendChild(b):alert("todo, no head tag found")},this)},loadEditor:function(){function a(){(!b.jquerySrc||b.jQuery)&&(!b.enableCKEditor||b.CKEDITOR)&&(!b.editorCss||b.cssLoaded)&&(b.CKEDITOR&&b.initCKEditor(b.CKEDITOR),b.cancelEditorLoad=null,b.initEditor(),b.editorReady=!0)}if(this.editorReady)return this;if(!this.documentLoaded)return this;
var b=this,c=[],d=b.getFrameWindow();if(Element.show(b.loader),b.cancelEditorLoad=function(){for(var a=c.length;--a>-1;)clearInterval(c[a]);b.cancelEditorLoad=null},b.enableCKEditor&&b.ckeditorSrc){b.CKEDITOR=null,b.loadScript(b.ckeditorSrc);var e=setInterval(function(){d.CKEDITOR&&"loaded"===d.CKEDITOR.status&&(b.CKEDITOR=d.CKEDITOR,clearInterval(e),a())},10);c.push(e)}if(b.jquerySrc){b.jQuery=null,b.loadScript(b.jquerySrc);var f=setInterval(function(){d.jQuery&&(b.initJQuery(d.jQuery),clearInterval(f),a())},10);c.push(f)}if(b.editorCss){b.cssLoaded=!1,b.loadStyle(b.editorCss);var g=setInterval(function(){b.cssLoaded=!0,clearInterval(g),a()},1e3);c.push(g)}return a(),this},initEditor:function(){function a(){var a,b=l(this),c=b.mage("id");c&&(a=i.getField(c,b.mage("index")).setElement(b))}function c(){var a,b,c=l(this),e=c.mage("id");if(e&&d(c.mage("editable")))return a=i.getField(e,c.mage("index")).setElement(c),c.is("img")?(a.type="image",c.on({click:function(b){i.editField(a,b)},mouseenter:function(){
c.addClass("mzax-editor-highlight-image")},mouseleave:function(){c.removeClass("mzax-editor-highlight-image")}}),"string"!=typeof a.value&&(a.value=c.attr("src")),"string"!=typeof a.alt&&(a.alt=c.attr("alt")||""),c.attr("src",i.getImagePreviewUrl(a.value)),void c.attr("alt",a.alt)):("string"==typeof a.value?c.html(a.value):a.setValue(c.html()),j&&(c.is("td")?b=l('<div class="mzax-inline-ckeditor" contenteditable="true" />').html(a.value).appendTo(c.empty()):c.is("div")&&(b=c.addClass("mzax-inline-ckeditor").addAttr("contenteditable",!0)),b)?(a.cke=j.inline(b[0],{autoParagraph:!1,allowedContent:!0,readOnly:!1,extraPlugins:"mage_code,mzax_editor,mzax_image",format_tags:"p;h1;h2;h3;h4;h5;h6;pre;address;div",stylesSet:i.getCustomStyles(),sharedSpaces:{top:"mzax-ckeditor-top"}}),a.cke.field=a,void a.cke.on("instanceReady",function(a){a.editor.setReadOnly(!1)})):void c.on({click:function(b){i.editField(a,b)},mouseenter:function(){c.addClass("mzax-editor-highlight")},mouseleave:function(){c.removeClass("mzax-editor-highlight");

}}))}function f(){var a,b,c=m,f=l(this),g=d(f.mage("repeatable")),j=d(f.mage("removable")),k=f.mage("id");if(k&&(j||g)&&!f.is(".mzax-removable-worker")){a=l('<div class="mzax-remove-handle"><span>'+h(k)+"</span></div>").appendTo(m).hide(),g&&a.addClass("mzax-repeatable"),b=i.getField(k,f.mage("index")).setElement(f),b.removable=!0,b.removeHandle=a,b.parent&&(c=b.parent.element,a.addClass("mzax-field-"+b.parent.uid)),f.addClass("mzax-removable-worker").on({mouseenter:function(){clearTimeout(o),(j||b.index)&&i.refreshUi()},mouseleave:function(b){a.hasElement(b.relatedTarget)||a.hide()},mousemove:function(c){g?b.index&&a.show():a.css({top:c.pageY-a.height()/2,left:f.offset().left-a.width()/2,opacity:1.2-(c.pageX-l(this).offset().left)/140}).show()}});var o;a.on({mousemove:function(c){if(!b.remove&&!g){var d=f.offset().top,h=f.height(),i=a.height()/2;a.css({top:e(c.pageY-i,d-i,d+h-i)})}},mouseenter:function(){clearTimeout(o),b.remove||n.moveOnTop(f).show()},mouseleave:function(){n.hide(),b.remove||a.hide();

},click:function(){if(j){clearTimeout(o);var c=b.remove=!b.remove;f.toggleClass("mzax-removed",c)[c?"fadeOut":"fadeIn"]("fast"),a.toggleClass("mzax-removed",c).fixedPosition(c&&!b.parent),n.hide(),c||(a.hide(),f.highlight())}else g&&b.index&&confirm("Are you sure?")&&(b.element.fadeOut(300,function(){b.flagAsDeleted(),i.reindexFields()}),n.fadeOut(300),a.hide());i.refreshUi(1)}}),b.remove&&(f.addClass("mzax-removed"),a.addClass("mzax-removed").fixedPosition(!b.parent),setTimeout(function(){f.hide()},500)),b.refreshUi(function(d){var e,h,i,k;if(!j&&!b.index)return void a.hide();if(f.is(".mzax-removed"))f.parents(".mzax-removed").length?a.hide():(c===m?(h=d.topOffset+10,k=5,i=a.prevAll(".mzax-remove-handle.mzax-removed:visible")):(e=c.offset(),h=e.top+25,k=Math.max(e.left+c.width()),i=a.prevAll(".mzax-remove-handle.mzax-field-"+b.parent.uid)),a.show().stop(!0,!1).animate({top:h+i.length*(a.height()+5),left:k,opacity:1},{duration:300,complete:function(){a.show()}}));else{var e=f.offset();g?(e.left+=f.width()-a.width()+3,
e.top+=-3):(e.left-=a.width()/2,delete e.top),a.css(e)}})}}function g(){var a,b,e,h=l(this),j=h.mage("id");if(j&&d(h.mage("repeatable"))){if(h.parents("[mage\\:repeatable]").length)return void h.removeAttr("mage:repeatable");a=l('<div class="mzax-repeat-handle"></div>').appendTo(m).hide(),e=l('<div class="mzax-swap-handle"></div>').appendTo(m).hide(),b=i.getField(j,h.mage("index")).setElement(h),b.repeatable=!0,b.repeatHandle=a,b.swapHandler=e;var k;h.on({mousemove:function(b){var c=b.pageY-l(this).offset().top,d=b.pageX-l(this).offset().left,f=e.is(":visible"),g=0,i=Math.min(h.height()/2-5,100);if(i>c?!f&&(k=h.prev('[mage\\:id="'+j+'"]:visible')).length&&(f=!0,swapDown=!1):c>h.height()-i?(!f&&(k=h.next('[mage\\:id="'+j+'"]:visible')).length&&(f=!0,swapDown=!0),g=h.height()):f=!1,f){var m=h.offset();m.top+=g-e.height()/2,m.left+=h.width()-20-e.width(),m.opacity=Math.min(1.5-(h.width()-d)/100,1.2-Math.abs(g-c)/50),e.css(m)}l(".mzax-swap-handle").not(e).hide(),e.toggle(f),a.css({opacity:1.1-(h.height()-c)/100
})},mouseenter:function(){l(".mzax-repeat-handle").hide(),a.show(),i.refreshUi()},mouseleave:function(b){e.hasElement(b.relatedTarget)||setTimeout(e.hide.bind(e),10),a.hasElement(b.relatedTarget)||a.hide()}}),e.on({mouseenter:function(){var a=Math.min(h.height(),k.height(),60)+"px";p.moveOnTop(k).toggleClass("mzax-a",swapDown).toggleClass("mzax-b",!swapDown).css("background-size",a).flicker().show(),q.moveOnTop(h).toggleClass("mzax-b",swapDown).toggleClass("mzax-a",!swapDown).css("background-size",a).flicker().show()},mouseleave:function(){p.moveOnTop(k).flicker(!1).hide(),q.moveOnTop(h).flicker(!1).hide()},click:function(){k.length&&(k[swapDown?"insertBefore":"insertAfter"](h).data("field").swap(b),swapDown=!swapDown,i.refreshUi()),e.hide()}}),a.on({mouseenter:function(){o.moveOnTop(h).show()},mouseleave:function(){o.hide()},click:function(){var a=b.index+1;i.insertField(b.id,a);var d=b.clone().find("[mage\\:id]").andSelf().attr("mage:index",a).end().end().insertAfter(b.element).each(f).each(g).find("[mage\\:editable]").each(c).end().find("[mage\\:removable]").each(f).end();

d.highlight()}});var n=i.fields[j];if(n.length>1)for(var r=1;r<n.length;r++)n[r].element||b.clone().find("[mage\\:id]").andSelf().attr("mage:index",r).end().end().insertAfter(b.element).each(f).each(g).find("[mage\\:editable]").each(c).end().find("[mage\\:removable]").each(f).end();b.refreshUi(function(){var b=h.offset();b.top+=h.height()-a.height()/2,b.left+=h.width()/2-a.width()/2,a.offset(b)})}}var i=this,j=i.CKEDITOR,k=i.getFrameWindow(),l=i.jQuery,m=l("body");if(l(k).on("resize scroll",function(){i.refreshUi(10)}),l("img").on("load error",function(){i.refreshUi(10)}),l(k).bind("keydown",function(a){if(8===a.keyCode){if(!l(a.target).is(".cke_editable,:input"))return void a.preventDefault();if(i.CKEDITOR&&i.CKEDITOR.currentInstance)try{0===i.CKEDITOR.currentInstance.getSelection().getRanges().length&&a.preventDefault()}catch(b){a.preventDefault()}}}),m.length){i.renderPlaceholders(!0);var n=l('<div class="mzax-remove-marker mzax-marker" />').appendTo(m),o=l('<div class="mzax-repeat-marker mzax-marker" />').appendTo(m),p=l('<div class="mzax-swap-marker mzax-marker mzax-a" />').appendTo(m),q=l('<div class="mzax-swap-marker mzax-marker mzax-b" />').appendTo(m);

customCss=l('<div class="mzax-custom-css" />').html("&laquo;CSS&raquo;").appendTo(m),l.fn.highlight=function(){var a=this;return a.scrollIntoView(function(){o.moveOnTop(a).show().fadeOut(1e3)},300)},i.allowCustomCss!==!1?(i.customCss=i.customCss||new b.ui.EditorField,i.customCss.type="css",i.customCss.setElement(l("<style />").appendTo("head").html(i.customCss.getValue())),customCss.click(function(){i.editField(i.customCss)})):customCss.remove(),l("[mage\\:id]").each(a),l("[mage\\:editable]").each(c),l("[mage\\:repeatable]").each(g).each(f),l("[mage\\:removable]").each(f)}this.disableLinks(function(a){alert("Link ("+a.href+")")}),this.refreshUi(),setTimeout(function(){Element.hide(i.loader)},500)},initCKEditor:function(a){var c=this,d=c.jQuery;c.CKEDITOR=a,a.owner=c,a.mzax=b,a.mageSnippets=c.snippets||{},a.disableAutoInline=!0,a.plugins.addExternal("mage_code,mzax_editor,mzax_image","/js/mzax/","ckeditor.plugin.mage.js"),a.on("instanceReady",c.refreshUi.bind(c)),a.on("currentInstance",c.refreshUi.bind(c)),
a.selectImageSource=function(a){c.browserMedia(a,!0)},a.getImagePreviewUrl=c.getImagePreviewUrl.bind(c),d("body").addClass("mzax-ckeditor-enabled"),d('<div id="mzax-ckeditor-top" />').prependTo("body")},initJQuery:function(a){var b=this,c=a(b.getFrameWindow());b.jQuery=a,k(a),a.fn.mage=function(a){return this.attr("mage:"+a)},a.fn.fixedPosition=function(b){var c=this.offset(),d=b?"fixed":"absolute",b=b?-1:1;return this.css("position")===d?this:this.css({position:d,top:c.top+a("body").scrollTop()*b,left:c.left+a("body").scrollLeft()*b})},a.fn.hasElement=function(b){return this.length>0&&(-1!==this.index(b)||a.contains(this[0],b))},a.fn.moveOnTop=function(a){var b=a.offset();return this.css({left:b.left,top:b.top,height:a.height(),width:a.width()})},a.fn.scrollIntoView=function(b,d){var e=(a("html, body"),parseInt(a("body").css("margin-top"))),f=c.scrollTop(),g=this.offset();return f<g.top&&f+c.height()>g.top+this.height()?(b.call(this),this):void a("html, body").animate({scrollTop:g.top-20-e
},{duration:d||150,complete:b})},a.fn.flicker=function(a,b){var c=this;if(a!==!1){var d=function(){c.animate({opacity:e(Math.random(),.2,1)},{duration:b||500,queue:"flicker",complete:d}).dequeue("flicker")};d()}else c.stop("flicker",!0,!1).css("opacity","");return this}},getImagePreviewUrl:function(a){var c=new b.ui.Placeholder(a);if(c.valid&&c.params.url){var d=this[c.directive+"Url"]||"/";return d+c.params.url}return a},reindexFields:function(a){var c,d,e,f,g=this,h=g.fields;if(h)for(d in h)if(h.hasOwnProperty(d)){for(f=[],e=h[d].length;--e>-1;)(c=h[d][e])&&!c.deleted&&f.push(c);for(f=f.sort(b.ui.EditorField.indexSort),e=f.length;--e>-1;)f[e].index=e,a&&a.call(f[e],f[e],e);h[d]=f}},refreshUi:function(a){function b(){if(c.ace&&c.ace.resize(),d){var a={window:e,editor:c,topOffset:d("#mzax-ckeditor-top").height(),height:e.height()};a.bottom=e.scrollTop()+a.height,a.top=e.scrollTop()+a.topOffset,c.CKEDITOR&&d("body").css("margin-top",a.topOffset),c.reindexFields(function(b){b.refreshUi(a);

})}}var c=this,d=c.jQuery,e=d?d(c.getFrameWindow()):null;this._refreshTimer&&clearTimeout(this._refreshTimer),a===!1?b():this._refreshTimer=setTimeout(b,a||5)},getField:function(a,c){var d=this,e=d.fields||(d.fields={});return c=c||0,e[a]||(e[a]=[]),e[a][c]||(e[a][c]=new b.ui.EditorField(a,1*c),e[a][c].onHtmlChange=function(a){a.find("img").on("load error",d.refreshUi.bind(d))}),this.fields[a][c]},insertField:function(a,b){var c,a,d,e=this,f=e.fields||(e.fields={});if(b=b||0,f.hasOwnProperty(a)){for(d=f[a].length;--d>=b;)(c=f[a][d])&&(c.index++,delete f[a][d],f[a][c.index]=c);c&&c._walk(function(a,c){e.insertField(c,b)})}},editField:function(b,c){function d(a){a&&(b.setValue(a),b.element.attr("src",e.getImagePreviewUrl(a)))}var e=this;switch(e.activeField=b,e.$.select(".controls .html-only").map(Element.hide),b.type){case"css":e.ace?(e.ace.getSession().setMode("ace/mode/css"),e.ace.setValue(b.getValue()),e.ace.clearSelection()):e.input.down("textarea").value=b.getValue(),Element.show(e.input);

break;case"html":e.ace?(e.ace.getSession().setMode("ace/mode/mage"),e.ace.setValue(b.getValue()),e.ace.clearSelection()):e.input.down("textarea").value=b.getValue(),e.$.select(".controls .html-only").map(Element.show),Element.show(e.input);break;case"image":c&&c.altKey?(b.alt=a.prompt("Please enter a alt text",b.alt),b.element&&b.element.attr("alt",b.alt)):c&&c.metaKey?d(a.prompt("Please enter any source path you like",b.value)):e.browserMedia(d,!0)}this.refreshUi()},getCustomStyles:function(){if(this._customStyles)return this._customStyles;var a,b,c,d,e,f,g,h=this.getFrameWindow().Array();if(this.html){if(g=this.html.match(/<style(\s+type="text\/css")?\s*>([\s\S]*)<\/style>/gim))for(a=g.length;--a>-1;)if(d=g[a].match(/\/\*\*[^{]*@name[\s\S]+?\*\/\s*[a-z0-9]+\.[a-z0-9_-]+\s*{[^}]*}/gim))for(b=d.length;--b>-1;)e=d[b].match(/@name\s+([a-z0-9 _-]+)/i),f=d[b].match(/([a-z0-9]+)\.([a-z0-9]+)\s{/i),c=d[b].match(/{([^}]+)?}/i),e&&f&&h.push({name:e[1],element:f[1],attributes:{"class":f[2]}});this._customStyles=h;

}return h},applyChanges:function(){var a=this.activeField;return a&&("html"===a.type||"css"===a.type)&&a.setValue(this.ace?this.ace.getValue():this.input.down("textarea").value),this.activeField=null,Element.hide(this.input),this},discardChanges:function(){return this.activeElement=null,this.activeObject=null,Element.hide(this.input),this},editMode:function(){this.editModeFlag=!0,this.loadEditor()},getBackgroundElements:function(){if(!this._bgElements){var b=[];$A(this.getDocument().getElementsByTagName("*")).each(function(c){var d=a.getComputedStyle(c);"none"!=d.backgroundImage&&b.push({element:c,background:d.backgroundImage})}),this._bgElements=b}return this._bgElements},toggleImages:function(a){this.imageFlag=a=void 0!==a?!!a:!this.imageFlag,this.select("img").each(function(b){a?b.src=b._src:(b._src=b._src||b.src,b.src="")}),this.getBackgroundElements().each(function(b){Element.setStyle(b.element,{backgroundImage:a?b.background:"none"})})},browserMedia:function(a,b){this.mediaBrowserUrl&&MediabrowserUtility.browse(this.mediaBrowserUrl,function(c){
if(c){var d=c.match(/\{\{([^\[\}])+\}\}/);a(b&&d?d[0]:c)}})},insertWidget:function(a){this.widgetToolsUrl&&widgetTools.openDialog(this.widgetToolsUrl,function(b){b&&a(b)})},disableLinks:function(a){var b=this;b._disableLinks=a,b.select("a").each(function(c){Element.observe(c,"click",function(d){Event.stop(d),a&&a.call(b,c)})})},loadTemplate:function(a){if(this.templateLoadUrl){var b=this;Element.show(b.loader),new Ajax.Request(b.templateLoadUrl,{parameters:{template:a},evalJSON:!0,onComplete:function(a){try{if(!a.responseJSON)throw"No valid JSON response: "+a.responseText;var c=a.responseJSON;if(c.error)throw c.message||"Unknown server error";c.html&&b.setHtml(c.html)}catch(d){alert(d)}}})}},quicksave:function(b,c){var d=this,e=d.quicksaveFields;if(b=b||d.quicksaveUrl,c=c||d.fieldName,b&&c){var f=["data["+c+"]="+encodeURIComponent(d.getValue())];FORM_KEY&&f.push("form_key="+FORM_KEY),e&&l(e,function(a,b){var c=$(a);c&&f.push("data["+b+"]="+encodeURIComponent(c.value))}),new Ajax.Request(b,{
postBody:f.join("&"),evalJSON:!0,onComplete:function(b){try{if(!b.responseJSON)throw"No valid JSON response: "+b.responseText;var c=b.responseJSON;if(c.error)throw c.message||"Unknown server error";for(var e=a.previewWindows||[],f=e.length;--f>-1;)try{e[f]&&e[f].call(d,{id:d.htmlId,editor:d})}catch(g){}varienGlobalEvents&&varienGlobalEvents.fireEvent("quicksave",{id:d.htmlId,editor:d})}catch(g){alert(g)}}.bind(this)})}return this}}),b.ui.TemplateEditor=Class.create({initialize:function(a,b){var c=this;b=b||{},c.mediaUrl="/media/",c.skinUrl="/skin/",c.storeUrl="/skin/",c.$=a,c.jquerySrc="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.js",c.editorCss="/skin/adminhtml/default/default/mzax/editor.css",c.enablePreview=!0,c.enableAce=!0,c.layout=1,c._options=b,Object.extend(this,b),c.init()},init:function(){var c=this,d=c.$;d.innerHTML='<div class="mzax-content mzax-content-editor"><textarea class="text-input"></textarea></div><div class="mzax-content mzax-content-preview"></div><div class="mzax-seperator"></div><div class="mzax-disable-ui"></div>',
d.addClassName("mzax-template-editor"),d.addClassName("mzax-editor"),c.$editor=d.down(".mzax-content-editor"),c.$preview=d.down(".mzax-content-preview"),c.$seperator=d.down(".mzax-seperator"),c.$disableUi=d.down(".mzax-disable-ui"),c.enableAce&&ace?(ace.require("ace/ext/mage_autocomplete"),c.ace=ace.edit(d.down(".text-input")),c.ace.owner=this,c.ace.setMageSnippets(c.snippets),c.ace.setTheme("ace/theme/mage"),c.ace.getSession().setMode("ace/mode/mage"),c.ace.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableMageLiveAutocompletion:!0}),c.ace.getSession().on("change",function(){c.updatePreview(1e3)})):d.down(".text-input").observe("keyup",function(){c.updatePreview(1e3)}),c.enablePreview&&(c.preview=new b.ui.PreviewFrame(c.$preview,Object.extend(c._options,{enableAce:c.enableAce,enableCKEditor:!1}))),this.switchLayout(this.layout);var c=this,e=this.$seperator,f=$(a.document);if(e){var g,h,i=function(){f.stopObserving("mouseup",i),f.stopObserving("mousemove",j),Element.hide(c.$disableUi);

},j=function(a){a.stop(),c.setSeperatorPosition(1===c.layout?(a.pageY-g.top)/(h.height||1):(a.pageX-g.left)/(h.width||1))};e.observe("mousedown",function(){g=c.$.cumulativeOffset(),h=c.$.getDimensions(),f.observe("mouseup",i),f.observe("mousemove",j),Element.show(c.$disableUi)})}Element.hide(c.$disableUi),varienGlobalEvents.attachEventHandler("formValidateAjaxComplete",function(a){var b=a.responseText.evalJSON().html_template_errors;if(b&&c.ace){var d=ace.require("ace/range").Range,e=c.ace.session;c.removeErrorHighlights();for(var f=b.length;--f>-1;)c.errorMarkers.push(e.addMarker(new d(b[f].line-1,0,b[f].line-1,b[f].column-1),"errorHighlight","line"))}})},removeErrorHighlights:function(){if(this.ace&&this.errorMarkers)for(var a=this.errorMarkers.length;--a>-1;)this.ace.getSession().removeMarker(this.errorMarkers[a]);return this.errorMarkers=[],this},setSeperatorPosition:function(a){var b=this;a=e(a,0,1),b._sepPos=a,b.$editor.writeAttribute("style",""),b.$preview.writeAttribute("style",""),
b.$seperator.writeAttribute("style","");var c=1===b.layout?["bottom","top"]:["right","left"],d={},f={};d[c[0]]=100-100*a+"%",f[c[1]]=100*a+"%",b.$editor.setStyle(d),b.$preview.setStyle(f),b.$seperator.setStyle(f),b.refreshUi()},switchLayout:function(a){var b=this.$,c="mzax-layout-";switch(this.layout=a||this.layout%2+1,b.removeClassName(c+"horz"),b.removeClassName(c+"vert"),this.layout){case 1:b.addClassName(c+"vert");break;case 2:b.addClassName(c+"horz")}return this.setSeperatorPosition(this._sepPos||.5),this},setValue:function(a){var b=this;return b.ace?(b.ace.setValue(a),b.ace.clearSelection()):b.$editor.down("textarea").value=a,b.updatePreview(!1),b},getValue:function(){return this.ace?this.ace.getValue():this.$editor.down("textarea").value},refreshUi:function(){this.ace&&this.ace.resize(),this.preview&&this.preview.refreshUi()},updatePreview:function(a){function b(){c.preview.setHtml(c.ace?c.ace.getValue():c.$editor.down("textarea").value,!0)}var c=this;return c.preview?(c._updateTimer&&clearTimeout(c._updateTimer),
void(a===!1?b():c._updateTimer=setTimeout(b,a||5))):!1},execCommand:function(a){return this.ace&&this.ace.execCommand(a,{source:"mage"}),this},insert:function(a){this.ace&&this.ace.insert(a)},browserMedia:function(){var a=this;this.mediaBrowserUrl&&MediabrowserUtility.browse(this.mediaBrowserUrl,function(b){b&&a.insert(b)})},insertWidget:function(){var a=this;this.widgetToolsUrl&&widgetTools.openDialog(this.widgetToolsUrl,function(b){b&&a.insert(b)})}}),b.ui.TextEditor=Class.create({initialize:function(a,b){var c=this;c.$=a,c.enableAce=!0,c.readOnly=!1,c.autosize=!1,c.useWrapMode=!1,Object.extend(this,b||{}),c.init()},init:function(){var b,c=this,d=c.$,e=j(d.innerHTML);d.innerHTML='<div class="mzax-content mzax-content-editor"><textarea class="text-input"></textarea></div>',d.addClassName("mzax-text-editor"),d.addClassName("mzax-editor"),c.$editor=d.down(".mzax-content-editor"),c.enableAce&&ace&&(b=c.ace=ace.edit(d.down(".text-input")),b.owner=this,b.setTheme(c.theme||"ace/theme/mage"),
b.getSession().setMode(c.mode||"ace/mode/mage"),b.getSession().setUseWrapMode(c.useWrapMode),b.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableMageLiveAutocompletion:!0}),b.setReadOnly(c.readOnly)),c.refreshUi(),Event.observe(a,"resize",function(){c.refreshUi()}),c.setValue(e)},doAutosize:function(){var a=this.ace;if(a){var b=a.getSession().getScreenLength()*a.renderer.lineHeight+a.renderer.scrollBar.getWidth()+25;this.$.setStyle({height:b.toString()+"px"})}else{var c=this.$editor.down("textarea");c.setStyle({height:"1px"}),c.setStyle({height:25+c.scrollHeight+"px"})}},execCommand:function(a){return this.ace&&this.ace.execCommand(a,{source:"mage"}),this},insert:function(a){this.ace&&this.ace.insert(a)},setValue:function(a){var b=this;return b.ace?(b.ace.setValue(a),b.ace.clearSelection()):b.$editor.down("textarea").value=a,b.refreshUi(),b},getValue:function(){return this.ace?this.ace.getValue():this.$editor.down("textarea").value},refreshUi:function(){this.autosize?(this.$.addClassName("mzax-autosize"),
this.doAutosize()):this.$.removeClassName("mzax-autosize"),this.ace&&this.ace.resize()}})}(window,window.mzax),function(a,b,c){function d(a){var b;return void 0!=a?b=Event.findElement(a,"DIV"):$$("div.selected").each(function(a){b=$(a.id)}),void 0==$(b.id)?!1:b.id}if(b&&c){var e=b.prototype.insert,f=c.closeDialog;b.prototype.insert=function(b){if(!a[this.targetElementId]||!c._callback)return e.call(this,b);var f,g=(a[this.targetElementId],d(b));return g?(f={filename:g,node:this.currentNode.id,store:this.storeId,as_is:1},void new Ajax.Request(this.onInsertUrl,{parameters:f,onSuccess:function(a){try{if(this.onAjaxSuccess(a),this.getMediaBrowserOpener()&&self.blur(),c._callback){var b=a.responseText;b=b.replace(/"[^"]*\{\{(.*?)\}\}[^"]*"/g,function(a){return'"'+a.substring(1,a.length-1).replace(/"/g,"'")+'"'}),c._callback.call(null,b),c._callback=null}Windows.close("browser_window")}catch(d){alert(d.message)}}.bind(this)})):!1},c.browse=function(a,b,c,d,e){this._callback=b,this.openDialog(a,c,d,e);

},c.closeDialog=function(a){return this._callback&&(this._callback.call(a,null),this._callback=null),f.call(this,a)}}}(window,Mediabrowser,MediabrowserUtility),function(a,b,c){if(b&&b.Widget&&c){var d=b.Widget,e=c.openDialog,f=c.closeDialog,g=d.prototype.insertWidget;d.prototype.insertWidget=function(){if(!a[this.widgetTargetId]&&!c._callback)return g.call(this);var b=(a[this.widgetTargetId],new varienForm(this.formEl));if(b.validator&&b.validator.validate()||!b.validator){var d=[],e=0;Form.getElements($(this.formEl)).each(function(a){a.hasClassName("skip-submit")||(d[e]=a,e++)});var f=Form.serializeElements(d);f+="&as_is=1",new Ajax.Request($(this.formEl).action,{parameters:f,onComplete:function(a){try{c.onAjaxSuccess(a),c._callback&&(c._callback.call(c,a.responseText),c._callback=null),Windows.close("widget_window")}catch(b){alert(b.message)}}.bind(this)})}},c.openDialog=function(a,b){return c._callback=b,e.call(c,a)},c.closeDialog=function(a){return c._callback&&(c._callback.call(a,null),
c._callback=null),f.call(this,a)}}}(window,WysiwygWidget,widgetTools);